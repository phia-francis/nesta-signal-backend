<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesta Signal Scout Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --nesta-purple: #9A1BBE; --nesta-green: #18A48C; --nesta-navy: #0F294A; }
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .font-nesta-display { font-family: 'Inter', sans-serif; font-weight: 800; letter-spacing: -0.02em; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--nesta-purple); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col text-nesta-navy">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-black text-white flex items-center justify-center font-bold rounded-sm">N</div>
                <h1 class="font-nesta-display text-xl">Signal Scout <span class="text-nesta-purple">Pro</span></h1>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadCSV()" class="text-sm font-semibold hover:text-nesta-purple">Export CSV</button>
                <button onclick="openSavedSignals()" class="text-sm font-semibold hover:text-black">Database</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full px-4 py-8 space-y-6">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-6">
            <input type="text" id="topic-input" class="block w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-black focus:border-black" placeholder="Enter topic (e.g. 'Synthetic Biology')..." onkeypress="handleEnter(event)">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Mission</label>
                    <select id="mission-select" class="w-full mt-1 p-2 border rounded bg-white"><option>All Missions</option><option>A Fairer Start</option><option>A Healthy Life</option><option>A Sustainable Future</option></select>
                </div>
                <div>
                    <div class="flex justify-between"><label class="text-xs font-bold text-gray-500 uppercase">Count</label><span id="count-display" class="font-bold text-nesta-purple">5</span></div>
                    <input type="range" id="signal-count" min="1" max="10" value="5" oninput="document.getElementById('count-display').innerText = this.value" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded border">
                    <span class="text-sm font-medium">Emerging Tech Only</span>
                    <input type="checkbox" id="tech-mode" class="w-5 h-5 text-black rounded focus:ring-0">
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Source Bias</label>
                <div class="flex flex-wrap gap-2" id="source-bias-container">
                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded border"><input type="checkbox" value="Academia"><span>Academia</span></label>
                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded border"><input type="checkbox" value="VC"><span>VC</span></label>
                    <label class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded border"><input type="checkbox" value="Substack"><span>Substack</span></label>
                </div>
            </div>

            <div class="flex justify-between items-center pt-4 border-t gap-4">
                <select id="time-filter" class="bg-gray-50 border-none text-sm font-semibold"><option>Past Month</option><option>Past Year</option></select>
                <div class="flex gap-3">
                    <button onclick="generateSignal(true)" class="px-6 py-2 border rounded hover:bg-gray-50 font-bold text-gray-700">Broad Scan</button>
                    <button id="search-btn" onclick="generateSignal(false)" class="px-8 py-2 bg-black text-white rounded font-bold hover:bg-gray-800 flex items-center gap-2">
                        <span>Execute</span><div id="btn-loader" class="loader hidden border-white border-t-transparent"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-controls" class="hidden flex justify-end gap-2">
            <button onclick="switchView('list')" id="btn-list" class="px-3 py-1 bg-black text-white text-xs rounded font-bold">List View</button>
            <button onclick="switchView('radar')" id="btn-radar" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded font-bold">Radar View</button>
        </div>

        <div id="result-container" class="space-y-6"></div>
        
        <div id="radar-container" class="hidden bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-[500px] flex items-center justify-center">
            <canvas id="signalRadar"></canvas>
        </div>

    </main>

    <div id="saved-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-2xl flex flex-col">
            <div class="p-6 border-b flex justify-between bg-gray-50">
                <h2 class="font-bold text-xl">Signal Database</h2>
                <button onclick="document.getElementById('saved-modal').classList.add('hidden')">âœ•</button>
            </div>
            <div id="saved-list" class="flex-1 overflow-y-auto p-6 bg-gray-100 space-y-4"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let currentSignals = [];
        let radarChart = null;

        function handleEnter(e) { if(e.key==='Enter') generateSignal(false); }
        function getCheckedSources() { return Array.from(document.querySelectorAll('#source-bias-container input:checked')).map(c=>c.value); }

        function switchView(view) {
            const list = document.getElementById('result-container');
            const radar = document.getElementById('radar-container');
            const btnList = document.getElementById('btn-list');
            const btnRadar = document.getElementById('btn-radar');

            if(view === 'list') {
                list.classList.remove('hidden'); radar.classList.add('hidden');
                btnList.classList.add('bg-black','text-white'); btnList.classList.remove('bg-gray-200','text-gray-600');
                btnRadar.classList.remove('bg-black','text-white'); btnRadar.classList.add('bg-gray-200','text-gray-600');
            } else {
                list.classList.add('hidden'); radar.classList.remove('hidden');
                btnRadar.classList.add('bg-black','text-white'); btnRadar.classList.remove('bg-gray-200','text-gray-600');
                btnList.classList.remove('bg-black','text-white'); btnList.classList.add('bg-gray-200','text-gray-600');
                renderRadar();
            }
        }

        function renderRadar() {
            const ctx = document.getElementById('signalRadar').getContext('2d');
            if(radarChart) radarChart.destroy();

            const dataPoints = currentSignals.map(s => ({
                x: s.score_novelty || Math.random()*10,
                y: s.score_evidence || Math.random()*10,
                r: 10, // Bubble radius
                title: s.title
            }));

            radarChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Signals Landscape',
                        data: dataPoints,
                        backgroundColor: 'rgba(154, 27, 190, 0.6)',
                        borderColor: '#9A1BBE',
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Novelty (0-10)' }, min: 0, max: 10 },
                        y: { title: { display: true, text: 'Evidence (0-10)' }, min: 0, max: 10 }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.raw.title;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function generateSignal(isBroad) {
            const topic = document.getElementById('topic-input').value;
            const loader = document.getElementById('btn-loader');
            const btn = document.getElementById('search-btn');
            const count = document.getElementById('signal-count').value;
            const mission = document.getElementById('mission-select').value;
            
            if(!topic && !isBroad) return alert("Please enter a topic");
            
            btn.disabled = true; loader.classList.remove('hidden');
            document.getElementById('result-container').innerHTML = '<div class="text-center py-10 animate-pulse text-gray-500">Scanning & Verifying (Deep Read Enabled)...</div>';
            document.getElementById('view-controls').classList.add('hidden');

            let prompt = isBroad ? 
                `Find ${count} high-novelty signals about ${mission}. Context: ${topic}` : 
                `Find ${count} signals about ${topic} for ${mission}`;

            try {
                const res = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: prompt,
                        time_filter: document.getElementById('time-filter').value,
                        source_types: getCheckedSources(),
                        tech_mode: document.getElementById('tech-mode').checked
                    })
                });
                const data = await res.json();
                
                if(data.ui_type === 'signal_list') {
                    currentSignals = data.items;
                    document.getElementById('result-container').innerHTML = '';
                    currentSignals.forEach(s => createCard(s));
                    document.getElementById('view-controls').classList.remove('hidden');
                } else {
                    document.getElementById('result-container').innerHTML = `<div class="p-4 bg-gray-100">${data.content}</div>`;
                }
            } catch(e) { console.error(e); alert("Scan failed."); }
            finally { btn.disabled = false; loader.classList.add('hidden'); }
        }

        function createCard(s, containerId='result-container') {
            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition";
            div.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="text-xs font-bold bg-purple-100 text-purple-800 px-2 py-1 rounded">${s.mission}</span>
                    <span class="text-sm font-bold bg-black text-white px-2 rounded-full flex items-center">${s.score||0}</span>
                </div>
                <h3 class="text-lg font-bold mb-2"><a href="${s.url}" target="_blank" class="hover:underline">${s.title}</a></h3>
                <p class="text-sm text-gray-600 mb-4">${s.hook}</p>
                <div class="flex gap-4 text-xs font-bold text-gray-400">
                    <span>NOVELTY: <span class="text-black">${s.score_novelty}</span></span>
                    <span>EVIDENCE: <span class="text-black">${s.score_evidence}</span></span>
                </div>
            `;
            document.getElementById(containerId).appendChild(div);
        }

        async function openSavedSignals() {
            document.getElementById('saved-modal').classList.remove('hidden');
            const res = await fetch(API_BASE_URL + '/api/saved');
            const data = await res.json();
            const list = document.getElementById('saved-list');
            list.innerHTML = '';
            currentSaved = data; // Store for CSV export if needed
            data.forEach(s => {
                // Adapt saved format to card format
                createCard({
                    title: s.Title, url: s.URL, hook: s.Hook, mission: s.Mission,
                    score: s.Score, score_novelty: s.Score_Novelty, score_evidence: s.Score_Evidence
                }, 'saved-list');
            });
        }

        function downloadCSV() {
            if(!currentSaved) return alert("Open Database first to load data");
            let csv = "Title,URL,Hook,Score,Mission\n";
            currentSaved.forEach(r => {
                csv += `"${r.Title}","${r.URL}","${r.Hook.replace(/"/g, '""')}",${r.Score},"${r.Mission}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'signals_export.csv';
            a.click();
        }
        
        let currentSaved = null;
    </script>
</body>
</html>
